import React, { useState, useEffect, useCallback } from 'react';
import { Calendar, Plus, Edit3, Trash2, Heart, Activity, Moon, Sun } from 'lucide-react';

const CycleCompanion = () => {
  const [currentDate, setCurrentDate] = useState(new Date());
  const [cycleData, setCycleData] = useState({
    periods: [],
    symptoms: {},
    notes: {},
    cycleLength: 28,
    periodLength: 5
  });
  const [selectedDate, setSelectedDate] = useState(null);
  const [showModal, setShowModal] = useState(false);
  const [modalType, setModalType] = useState('period');

  // Initialize with sample data for demonstration
  useEffect(() => {
    const sampleData = {
      periods: [
        { date: new Date(2025, 5, 15).toDateString(), type: 'start' },
        { date: new Date(2025, 5, 16).toDateString(), type: 'period' },
        { date: new Date(2025, 5, 17).toDateString(), type: 'period' },
        { date: new Date(2025, 5, 18).toDateString(), type: 'period' },
        { date: new Date(2025, 5, 19).toDateString(), type: 'end' }
      ],
      symptoms: {
        [new Date(2025, 5, 14).toDateString()]: ['cramps', 'mood'],
        [new Date(2025, 5, 20).toDateString()]: ['bloating']
      },
      notes: {
        [new Date(2025, 5, 15).toDateString()]: 'First day of cycle'
      },
      cycleLength: 28,
      periodLength: 5
    };
    setCycleData(sampleData);
  }, []);

  const getDaysInMonth = (date) => {
    return new Date(date.getFullYear(), date.getMonth() + 1, 0).getDate();
  };

  const getFirstDayOfMonth = (date) => {
    return new Date(date.getFullYear(), date.getMonth(), 1).getDay();
  };

  const formatDate = (date) => {
    return date.toDateString();
  };

  const isPeriodDate = (date) => {
    const dateStr = formatDate(date);
    return cycleData.periods.some(period => period.date === dateStr);
  };

  const isSymptomDate = (date) => {
    const dateStr = formatDate(date);
    return cycleData.symptoms[dateStr] && cycleData.symptoms[dateStr].length > 0;
  };

  const hasNote = (date) => {
    const dateStr = formatDate(date);
    return cycleData.notes[dateStr] && cycleData.notes[dateStr].length > 0;
  };

  const getPredictedDates = () => {
    if (cycleData.periods.length === 0) return [];
    
    const lastPeriodStart = cycleData.periods
      .filter(p => p.type === 'start')
      .sort((a, b) => new Date(b.date) - new Date(a.date))[0];
    
    if (!lastPeriodStart) return [];
    
    const lastDate = new Date(lastPeriodStart.date);
    const predicted = [];
    
    // Predict next 3 cycles
    for (let i = 1; i <= 3; i++) {
      const nextStart = new Date(lastDate);
      nextStart.setDate(lastDate.getDate() + (cycleData.cycleLength * i));
      
      for (let j = 0; j < cycleData.periodLength; j++) {
        const periodDate = new Date(nextStart);
        periodDate.setDate(nextStart.getDate() + j);
        predicted.push(periodDate);
      }
    }
    
    return predicted;
  };

  const isPredictedDate = (date) => {
    const predicted = getPredictedDates();
    return predicted.some(pred => 
      pred.getDate() === date.getDate() && 
      pred.getMonth() === date.getMonth() && 
      pred.getFullYear() === date.getFullYear()
    );
  };

  const handleDateClick = (date) => {
    setSelectedDate(date);
    setShowModal(true);
  };

  const addPeriodData = (date, type) => {
    const dateStr = formatDate(date);
    setCycleData(prev => ({
      ...prev,
      periods: [...prev.periods.filter(p => p.date !== dateStr), { date: dateStr, type }]
    }));
  };

  const addSymptom = (date, symptom) => {
    const dateStr = formatDate(date);
    setCycleData(prev => ({
      ...prev,
      symptoms: {
        ...prev.symptoms,
        [dateStr]: [...(prev.symptoms[dateStr] || []), symptom]
      }
    }));
  };

  const addNote = (date, note) => {
    const dateStr = formatDate(date);
    setCycleData(prev => ({
      ...prev,
      notes: {
        ...prev.notes,
        [dateStr]: note
      }
    }));
  };

  const removeData = (date, type) => {
    const dateStr = formatDate(date);
    setCycleData(prev => {
      const newData = { ...prev };
      
      if (type === 'period') {
        newData.periods = prev.periods.filter(p => p.date !== dateStr);
      } else if (type === 'symptoms') {
        delete newData.symptoms[dateStr];
      } else if (type === 'note') {
        delete newData.notes[dateStr];
      }
      
      return newData;
    });
  };

  const renderCalendarGrid = () => {
    const daysInMonth = getDaysInMonth(currentDate);
    const firstDay = getFirstDayOfMonth(currentDate);
    const days = [];
    
    // Empty cells for days before the first day of the month
    for (let i = 0; i < firstDay; i++) {
      days.push(<div key={`empty-${i}`} className="h-24 bg-gray-50"></div>);
    }
    
    // Days of the month
    for (let day = 1; day <= daysInMonth; day++) {
      const date = new Date(currentDate.getFullYear(), currentDate.getMonth(), day);
      const isToday = date.toDateString() === new Date().toDateString();
      const isPeriod = isPeriodDate(date);
      const hasSymptoms = isSymptomDate(date);
      const hasNoteData = hasNote(date);
      const isPredicted = isPredictedDate(date);
      
      days.push(
        <div
          key={day}
          onClick={() => handleDateClick(date)}
          className={`h-24 border border-gray-200 p-2 cursor-pointer hover:bg-gray-50 relative
            ${isToday ? 'bg-blue-100 border-blue-300' : ''}
            ${isPeriod ? 'bg-red-100' : ''}
            ${isPredicted ? 'bg-pink-50 border-pink-200' : ''}
          `}
        >
          <div className="font-medium text-sm">{day}</div>
          <div className="flex flex-col gap-1 mt-1">
            {isPeriod && (
              <div className="w-2 h-2 bg-red-500 rounded-full"></div>
            )}
            {isPredicted && !isPeriod && (
              <div className="w-2 h-2 bg-pink-300 rounded-full border border-pink-400"></div>
            )}
            {hasSymptoms && (
              <Activity className="w-3 h-3 text-orange-500" />
            )}
            {hasNoteData && (
              <Edit3 className="w-3 h-3 text-blue-500" />
            )}
          </div>
        </div>
      );
    }
    
    return days;
  };

  const Modal = ({ isOpen, onClose, date }) => {
    const [activeTab, setActiveTab] = useState('period');
    const [symptomInput, setSymptomInput] = useState('');
    const [noteInput, setNoteInput] = useState('');

    useEffect(() => {
      if (date && hasNote(date)) {
        setNoteInput(cycleData.notes[formatDate(date)] || '');
      } else {
        setNoteInput('');
      }
    }, [date]);

    if (!isOpen || !date) return null;

    const dateStr = formatDate(date);
    const currentSymptoms = cycleData.symptoms[dateStr] || [];

    return (
      <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div className="bg-white rounded-lg p-6 w-96 max-h-96 overflow-y-auto">
          <div className="flex justify-between items-center mb-4">
            <h3 className="text-lg font-semibold">
              {date.toLocaleDateString('en-US', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
              })}
            </h3>
            <button onClick={onClose} className="text-gray-500 hover:text-gray-700">
              Ã—
            </button>
          </div>

          <div className="flex space-x-2 mb-4">
            {['period', 'symptoms', 'notes'].map((tab) => (
              <button
                key={tab}
                onClick={() => setActiveTab(tab)}
                className={`px-3 py-1 rounded text-sm ${
                  activeTab === tab 
                    ? 'bg-blue-500 text-white' 
                    : 'bg-gray-200 text-gray-700'
                }`}
              >
                {tab.charAt(0).toUpperCase() + tab.slice(1)}
              </button>
            ))}
          </div>

          {activeTab === 'period' && (
            <div className="space-y-3">
              <div className="flex flex-wrap gap-2">
                <button 
                  onClick={() => addPeriodData(date, 'start')}
                  className="px-3 py-1 bg-red-500 text-white rounded text-sm"
                >
                  Period Start
                </button>
                <button 
                  onClick={() => addPeriodData(date, 'period')}
                  className="px-3 py-1 bg-red-400 text-white rounded text-sm"
                >
                  Period Day
                </button>
                <button 
                  onClick={() => addPeriodData(date, 'end')}
                  className="px-3 py-1 bg-red-300 text-white rounded text-sm"
                >
                  Period End
                </button>
              </div>
              {isPeriodDate(date) && (
                <button 
                  onClick={() => removeData(date, 'period')}
                  className="px-3 py-1 bg-gray-500 text-white rounded text-sm"
                >
                  Remove Period Data
                </button>
              )}
            </div>
          )}

          {activeTab === 'symptoms' && (
            <div className="space-y-3">
              <div className="flex flex-wrap gap-2">
                {['cramps', 'bloating', 'mood', 'headache', 'fatigue', 'tender_breasts'].map((symptom) => (
                  <button
                    key={symptom}
                    onClick={() => addSymptom(date, symptom)}
                    className={`px-3 py-1 rounded text-sm ${
                      currentSymptoms.includes(symptom)
                        ? 'bg-orange-500 text-white'
                        : 'bg-gray-200 text-gray-700'
                    }`}
                  >
                    {symptom.replace('_', ' ')}
                  </button>
                ))}
              </div>
              {currentSymptoms.length > 0 && (
                <button 
                  onClick={() => removeData(date, 'symptoms')}
                  className="px-3 py-1 bg-gray-500 text-white rounded text-sm"
                >
                  Clear Symptoms
                </button>
              )}
            </div>
          )}

          {activeTab === 'notes' && (
            <div className="space-y-3">
              <textarea
                value={noteInput}
                onChange={(e) => setNoteInput(e.target.value)}
                placeholder="Add a note for this day..."
                className="w-full p-2 border border-gray-300 rounded resize-none h-20"
              />
              <div className="flex gap-2">
                <button 
                  onClick={() => {
                    addNote(date, noteInput);
                    onClose();
                  }}
                  className="px-3 py-1 bg-blue-500 text-white rounded text-sm"
                >
                  Save Note
                </button>
                {hasNote(date) && (
                  <button 
                    onClick={() => removeData(date, 'note')}
                    className="px-3 py-1 bg-gray-500 text-white rounded text-sm"
                  >
                    Delete Note
                  </button>
                )}
              </div>
            </div>
          )}
        </div>
      </div>
    );
  };

  const navigateMonth = (direction) => {
    setCurrentDate(prev => {
      const newDate = new Date(prev);
      newDate.setMonth(prev.getMonth() + direction);
      return newDate;
    });
  };

  return (
    <div className="min-h-screen bg-gradient-to-br from-pink-50 to-purple-50 p-4">
      <div className="max-w-6xl mx-auto">
        {/* Header */}
        <div className="text-center mb-8">
          <h1 className="text-4xl font-bold text-purple-800 mb-2 flex items-center justify-center gap-2">
            <Heart className="w-8 h-8 text-pink-500" />
            Cycle Companion
          </h1>
          <p className="text-purple-600">Track your cycle with care and confidence</p>
        </div>

        {/* Calendar Navigation */}
        <div className="bg-white rounded-lg shadow-lg p-6 mb-6">
          <div className="flex justify-between items-center mb-6">
            <button 
              onClick={() => navigateMonth(-1)}
              className="px-4 py-2 bg-purple-500 text-white rounded hover:bg-purple-600 transition-colors"
            >
              Previous
            </button>
            <h2 className="text-2xl font-semibold text-gray-800">
              {currentDate.toLocaleDateString('en-US', { month: 'long', year: 'numeric' })}
            </h2>
            <button 
              onClick={() => navigateMonth(1)}
              className="px-4 py-2 bg-purple-500 text-white rounded hover:bg-purple-600 transition-colors"
            >
              Next
            </button>
          </div>

          {/* Calendar Grid */}
          <div className="grid grid-cols-7 gap-1 mb-4">
            {['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].map(day => (
              <div key={day} className="h-12 flex items-center justify-center font-semibold text-gray-600 bg-gray-100">
                {day}
              </div>
            ))}
          </div>
          <div className="grid grid-cols-7 gap-1">
            {renderCalendarGrid()}
          </div>

          {/* Legend */}
          <div className="flex flex-wrap gap-4 mt-6 text-sm">
            <div className="flex items-center gap-2">
              <div className="w-3 h-3 bg-red-500 rounded-full"></div>
              <span>Period Days</span>
            </div>
            <div className="flex items-center gap-2">
              <div className="w-3 h-3 bg-pink-300 rounded-full border border-pink-400"></div>
              <span>Predicted Period</span>
            </div>
            <div className="flex items-center gap-2">
              <Activity className="w-3 h-3 text-orange-500" />
              <span>Symptoms</span>
            </div>
            <div className="flex items-center gap-2">
              <Edit3 className="w-3 h-3 text-blue-500" />
              <span>Notes</span>
            </div>
          </div>
        </div>

        {/* Cycle Statistics */}
        <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
          <div className="bg-white rounded-lg shadow-lg p-6">
            <h3 className="text-lg font-semibold text-gray-800 mb-2">Cycle Length</h3>
            <p className="text-3xl font-bold text-purple-600">{cycleData.cycleLength} days</p>
          </div>
          <div className="bg-white rounded-lg shadow-lg p-6">
            <h3 className="text-lg font-semibold text-gray-800 mb-2">Period Length</h3>
            <p className="text-3xl font-bold text-pink-600">{cycleData.periodLength} days</p>
          </div>
          <div className="bg-white rounded-lg shadow-lg p-6">
            <h3 className="text-lg font-semibold text-gray-800 mb-2">Days Tracked</h3>
            <p className="text-3xl font-bold text-blue-600">{cycleData.periods.length}</p>
          </div>
        </div>
      </div>

      <Modal 
        isOpen={showModal} 
        onClose={() => setShowModal(false)} 
        date={selectedDate}
      />
    </div>
  );
};

export default CycleCompanion;
